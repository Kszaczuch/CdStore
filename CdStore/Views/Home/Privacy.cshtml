@using Microsoft.AspNetCore.Mvc.Rendering
@model List<CdStore.Models.Album>
@{
    ViewData["Title"] = "Zarządzanie produktów";
    var sel = ViewBag.SelectedAlbum as CdStore.Models.Album;
    var categories = ViewBag.Categories as List<CdStore.Models.Kategoria> ?? new List<CdStore.Models.Kategoria>();
}
<h1 class="mb-4">@ViewData["Title"]</h1>

<div class="card bg-dark text-white mb-4">
    <div class="card-body">
        <form id="product-form" asp-action="SaveProductForm" method="post" class="row g-2 align-items-center needs-validation" novalidate>
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" value="@(sel != null ? sel.Id.ToString() : "")" />
            <div class="col-md-3">
                <input name="OkladkaLink" maxlength="500" class="form-control text-white bg-dark" placeholder="Link do zdjęcia (OkladkaLink)" value="@(sel?.OkladkaLink ?? "")" />
            </div>
            <div class="col-md-3">
                <input name="Tytul" maxlength="200" class="form-control text-white bg-dark" placeholder="Nazwa (Tytul)" value="@(sel?.Tytul ?? "")" required />
                <div class="invalid-feedback">Nazwa jest wymagana.</div>
            </div>
            <div class="col-md-2">
                <input name="Artysta" maxlength="150" class="form-control text-white bg-dark" placeholder="Wykonawca (Artysta)" value="@(sel?.Artysta ?? "")" required />
                <div class="invalid-feedback">Wykonawca jest wymagany.</div>
            </div>

            <div class="col-md-2">
                <label class="form-label visually-hidden">Gatunek</label>
                <select name="KategoriaId" class="form-select bg-dark text-white" asp-items="@(new SelectList(categories, "Id", "Nazwa", sel?.KategoriaId))">
                    <option value="">- brak -</option>
                </select>
            </div>

            <div class="col-md-1">
                <input name="Cena" type="number" step="0.01" min="0" max="100000" class="form-control text-white bg-dark" placeholder="Cena" value="@(sel != null ? sel.Cena.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) : "")" required />
                <div class="invalid-feedback">Podaj poprawną cenę.</div>
            </div>
            <div class="col-md-1">
                <input name="IloscNaStanie" type="number" step="1" min="0" class="form-control text-white bg-dark" placeholder="Ilość" value="@(sel != null ? sel.IloscNaStanie.ToString() : "")" required />
                <div class="invalid-feedback">Podaj ilość (>= 0).</div>
            </div>

            <div class="col-12 mt-2">
                <label class="form-label">Opis</label>
                <textarea name="Opis" maxlength="2000" class="form-control text-white bg-dark" rows="6">@sel?.Opis</textarea>
            </div>
            <div class="col-12 d-flex justify-content-end mt-2">
                <button type="submit" class="btn btn-outline-success me-2">Zapisz</button>
                @if (sel != null && sel.Id != 0)
                {
                    <button type="button" id="cancel-edit-btn" class="btn btn-outline-secondary">Anuluj</button>
                }
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-dark table-striped align-middle">
        <thead>
            <tr>
                <th style="width:90px"></th>
                <th>Nazwa - Wykonawca</th>
                <th style="width:160px">Gatunek</th>
                <th style="width:120px" class="text-end">Cena</th>
                <th style="width:120px" class="text-end">Ilość</th>
                <th style="width:160px" class="text-end"></th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Count > 0)
            {
                foreach (var a in Model)
                {
                    <tr>
                        <td class="text-start">
                            <img class="img-fluid rounded" src="@a.OkladkaLink" alt="@a.Tytul" style="max-width:80px" />
                        </td>
                        <td>
                            @a.Tytul - @a.Artysta
                        </td>
                        <td>
                            <span class="text-muted small">@a.Kategoria?.Nazwa</span>
                        </td>
                        <td class="text-end">@a.Cena.ToString("C")</td>
                        <td class="text-end">@a.IloscNaStanie.ToString()</td>
                        <td class="text-end" style="white-space:nowrap;">
                            <div class="d-inline-flex gap-2 align-items-center">
                                <a class="btn btn-sm btn-outline-info" href="@Url.Action("Privacy", new { id = a.Id })">Edytuj</a>

                                <form asp-action="DeleteProductForm" method="post" class="m-0 p-0">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@a.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Na pewno usunąć produkt?');">Usuń</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6">Brak produktów.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        (function () {
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });

            var cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function () {
                    var form = document.getElementById('product-form');
                    if (!form) return;

                    var names = ['Id', 'OkladkaLink', 'Tytul', 'Artysta', 'KategoriaId', 'Cena', 'IloscNaStanie', 'Opis'];
                    names.forEach(function (n) {
                        var el = form.querySelector('[name="' + n + '"]');
                        if (!el) return;
                        if (el.tagName.toLowerCase() === 'select') {
                            el.value = '';
                        } else if (el.type === 'checkbox' || el.type === 'radio') {
                            el.checked = false;
                        } else {
                            el.value = '';
                        }
                    });

                    form.classList.remove('was-validated');
                    var invalids = form.querySelectorAll('.is-invalid, .is-valid');
                    invalids.forEach(function (i) { i.classList.remove('is-invalid'); i.classList.remove('is-valid'); });

                    cancelBtn.style.display = 'none';

                    var first = form.querySelector('input, textarea, select');
                    if (first) first.focus();
                });
            }
        })();
    </script>
}