@model IEnumerable<CdStore.Models.Users>
@inject Microsoft.AspNetCore.Identity.UserManager<CdStore.Models.Users> userManager

<h2>Lista użytkowników</h2>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@{ 
    var currentUserId = userManager.GetUserId(User);
}

<table class="table table-dark table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Email</th>
            <th>Imię i nazwisko</th>
            <th>Admin?</th>
            <th>Zablokowany?</th>
            <th>Akcja</th>
        </tr>
    </thead>
    <tbody class="text-white">
        @foreach (var u in Model)
        {
            var isAdmin = await userManager.IsInRoleAsync(u, "Admin");
            <tr>
                <td>@u.Id</td>
                <td>@u.Email</td>
                <td>@u.FullName</td>
                <td>@(isAdmin ? "TAK" : "NIE")</td>
                <td>@(u.IsBlocked ? "TAK" : "NIE")</td>
                <td>
                    <div class="d-flex flex-row flex-wrap align-items-center gap-2">
                        @if (isAdmin)
                        {
                            if (u.Id != currentUserId)
                            {
                                <form asp-action="RemoveAdmin" method="post" class="m-0">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@u.Id" />
                                    <button type="submit" class="btn btn-danger" title="Usuń uprawnienia admina">Usuń admina</button>
                                </form>
                            }
                            else
                            {
                                <button class="btn btn-secondary" disabled title="Nie możesz usunąć uprawnień admina od siebie">Usuń admina</button>
                            }
                        }
                        else
                        {
                            <form asp-action="MakeAdmin" method="post" class="m-0">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@u.Id" />
                                <button type="submit" class="btn btn-outline-success" title="Nadaj uprawnienia admina">Nadaj admina</button>
                            </form>

                            <form asp-action="ToggleBlock" method="post" class="m-0">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@u.Id" />
                                <button type="submit" class="btn @(u.IsBlocked ? "btn-warning" : "btn-outline-warning")">
                                    @(u.IsBlocked ? "Odblokuj" : "Zablokuj")
                                </button>
                            </form>
                        }
                    </div>
                </td>
            </tr>
        }
    </tbody>
</table>